name: Deploy to Google Cloud

on:
  push:
    branches: [ master ]
    # Trigger on any push to master (we'll check for changes in the workflow)
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: read
  id-token: write  # Required for Workload Identity Federation

jobs:
  deploy-api:
    name: Deploy API to Cloud Run
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: ./api
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to check for changes

      - name: Check for API changes
        id: check-api-changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - always deploy
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Manual trigger - deploying API"
          else
            # Check if API files changed in this push
            # Compare with the base commit (before this push)
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.event.after }}"
            
            if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]; then
              # First commit or can't determine base - check if api/ exists and has files
              if [ -d "api" ] && [ -n "$(find api -type f -name '*.java' -o -name 'pom.xml' -o -name '*.properties' 2>/dev/null | head -1)" ]; then
                echo "changed=true" >> $GITHUB_OUTPUT
                echo "âœ… Initial commit or unable to determine base - deploying API"
              else
                echo "changed=false" >> $GITHUB_OUTPUT
                echo "â­ï¸  No API directory or files found - skipping deployment"
              fi
            else
              # Check if API files changed between base and head
              if git diff --name-only $BASE_SHA $HEAD_SHA | grep -q "^api/"; then
                echo "changed=true" >> $GITHUB_OUTPUT
                echo "âœ… API files changed - deploying"
                echo "Changed API files:"
                git diff --name-only $BASE_SHA $HEAD_SHA | grep "^api/" || true
              else
                echo "changed=false" >> $GITHUB_OUTPUT
                echo "â­ï¸  No API changes detected - skipping deployment"
              fi
            fi
          fi

      - name: Authenticate to Google Cloud
        if: steps.check-api-changes.outputs.changed == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        if: steps.check-api-changes.outputs.changed == 'true'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Deploy API to Cloud Run
        if: steps.check-api-changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          SMTP_HOST: ${{ vars.SMTP_HOST }}
          SMTP_PORT: ${{ vars.SMTP_PORT }}
          SMTP_USERNAME: ${{ vars.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          CONTACT_EMAIL: ${{ secrets.CONTACT_EMAIL }}
          SMTP_FROM_EMAIL: ${{ vars.SMTP_FROM_EMAIL }}
          TURNSTILE_SECRET_KEY: ${{ secrets.TURNSTILE_SECRET_KEY }}
        run: |
          REGION=us-east1
          SERVICE=ricky-api
          
          # Build environment variables string
          ENV_VARS=""
          if [ -n "$GH_TOKEN" ]; then
            ENV_VARS="GH_TOKEN=$GH_TOKEN"
          fi
          if [ -n "$ADMIN_API_KEY" ]; then
            if [ -n "$ENV_VARS" ]; then
              ENV_VARS="$ENV_VARS,ADMIN_API_KEY=$ADMIN_API_KEY"
            else
              ENV_VARS="ADMIN_API_KEY=$ADMIN_API_KEY"
            fi
          fi
          if [ -n "$SMTP_HOST" ]; then
            if [ -n "$ENV_VARS" ]; then
              ENV_VARS="$ENV_VARS,SMTP_HOST=$SMTP_HOST"
            else
              ENV_VARS="SMTP_HOST=$SMTP_HOST"
            fi
          fi
          if [ -n "$SMTP_PORT" ]; then
            ENV_VARS="$ENV_VARS,SMTP_PORT=$SMTP_PORT"
          fi
          if [ -n "$SMTP_USERNAME" ]; then
            ENV_VARS="$ENV_VARS,SMTP_USERNAME=$SMTP_USERNAME"
          fi
          if [ -n "$SMTP_PASSWORD" ]; then
            ENV_VARS="$ENV_VARS,SMTP_PASSWORD=$SMTP_PASSWORD"
          fi
          if [ -n "$CONTACT_EMAIL" ]; then
            ENV_VARS="$ENV_VARS,CONTACT_EMAIL=$CONTACT_EMAIL"
          fi
          if [ -n "$SMTP_FROM_EMAIL" ]; then
            ENV_VARS="$ENV_VARS,SMTP_FROM_EMAIL=$SMTP_FROM_EMAIL"
          fi
          if [ -n "$TURNSTILE_SECRET_KEY" ]; then
            ENV_VARS="$ENV_VARS,TURNSTILE_SECRET_KEY=$TURNSTILE_SECRET_KEY"
          fi
          
          echo "ðŸš€ Deploying API to Cloud Run..."
          echo "   Service: $SERVICE"
          echo "   Region:  $REGION"
          
          if [ -n "$ENV_VARS" ]; then
            gcloud run deploy $SERVICE \
              --region $REGION \
              --source . \
              --allow-unauthenticated \
              --set-env-vars "$ENV_VARS" \
              --min-instances=0 \
              --max-instances=3 \
              --memory=512Mi \
              --cpu=1
          else
            gcloud run deploy $SERVICE \
              --region $REGION \
              --source . \
              --allow-unauthenticated \
              --min-instances=0 \
              --max-instances=3 \
              --memory=512Mi \
              --cpu=1
          fi
          
          # Get service URL
          SERVICE_URL=$(gcloud run services describe $SERVICE --region $REGION --format 'value(status.url)')
          echo "âœ… API deployed successfully!"
          echo "   URL: $SERVICE_URL"

  deploy-site:
    name: Deploy Site to Cloud Storage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Deploy Site to Cloud Storage
        env:
          BUCKET_NAME: ${{ vars.GCS_BUCKET_NAME }}
        run: |
          if [ -z "$BUCKET_NAME" ]; then
            echo "âš ï¸  GCS_BUCKET_NAME variable not set, skipping site deployment"
            exit 0
          fi
          
          echo "ðŸš€ Deploying site to Cloud Storage..."
          echo "   Bucket: $BUCKET_NAME"
          
          # Sync files to bucket (excluding git, node_modules, etc.)
          gsutil -m rsync -d -x '\.git/.*|node_modules/.*|\.github/.*|api/.*|tests/.*|test-results/.*|playwright-report/.*|\.env.*|\.DS_Store|package-lock\.json|tsconfig\.json|playwright\.config\.ts|\.gitignore|README\.md|docs/.*' . "gs://${BUCKET_NAME}/"
          
          # Set bucket to serve static website
          gsutil web set -m index.html -e 404.html "gs://${BUCKET_NAME}/"
          
          # Make files publicly readable
          gsutil -m acl ch -r -u AllUsers:R "gs://${BUCKET_NAME}/"
          
          # Get bucket URL
          BUCKET_URL="https://storage.googleapis.com/$BUCKET_NAME"
          echo "âœ… Site deployed successfully!"
          echo "   URL: $BUCKET_URL"

      - name: Skip API deployment notification
        if: steps.check-api-changes.outputs.changed != 'true'
        run: |
          echo "â­ï¸  API deployment skipped - no API changes detected"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Deployment" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-api-changes.outputs.changed }}" == "true" ]; then
            echo "- âœ… API deployed to Cloud Run" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸  API deployment skipped (no API changes)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ vars.GCS_BUCKET_NAME }}" ]; then
            echo "### Site Deployment" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Site deployed to Cloud Storage" >> $GITHUB_STEP_SUMMARY
            echo "- URL: https://storage.googleapis.com/${{ vars.GCS_BUCKET_NAME }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Site Deployment" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸  Site deployment skipped (GCS_BUCKET_NAME not configured)" >> $GITHUB_STEP_SUMMARY
          fi

